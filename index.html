<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Marq</title>
    <style>
        /* CSS remains largely the same, with key additions for polishing */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Amiri:ital@1&display=swap');
        :root {
            --ease-out-quint: cubic-bezier(0.22, 1, 0.36, 1);
            --ease-in-out-sine: cubic-bezier(0.37, 0, 0.63, 1);
            --app-background: #000;
            --tadelakt-start: #282828;
            --tadelakt-end: #1a1a1a;
            --aluminum-light: #888;
            --aluminum-dark: #444;
            --text-primary: #e0e0e0;
            --text-secondary: #999;
            --ochre-gold: #c67605;
            --riad-background: #fdfcf9;
            --riad-text: #2d2d2d;
            /* Step 1: Add CSS variables for gyroscope-driven light effect */
            --gyro-x: 0;
            --gyro-y: 0;
        }
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; background-color: var(--app-background); font-family: 'Inter', sans-serif; color: var(--text-primary); overflow: hidden; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; touch-action: manipulation; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; visibility: hidden; transition: opacity 0.8s var(--ease-in-out-sine), visibility 0.8s; display: flex; justify-content: center; align-items: center; will-change: opacity; }
        .screen.active { opacity: 1; visibility: visible; }
        body.transition-locked { pointer-events: none; }
        
        /* Step 1: Define the metallic sheen for the astrolabe */
        .astrolabe-sheen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at calc(50% + var(--gyro-x) * 20%) calc(50% + var(--gyro-y) * 20%), rgba(255,255,255,0.1), transparent 50%);
            transition: background 0.1s linear;
            pointer-events: none;
        }

        /* Step 2: Define the narrative transition for the Astrolabe */
        #astrolabe-screen.deconstruct .astrolabe-container {
            transition: transform 0.8s var(--ease-in-out-sine);
            transform: scale(3) !important;
            opacity: 0;
        }

        /* Step 3: Define the staggered revelation for Riad content */
        .revealable {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s var(--ease-out-quint), transform 0.8s var(--ease-out-quint);
        }
        .revealable.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Step 5: Styles for the new Tapestry screen */
        #tapestry-screen {
            flex-direction: column;
            background-color: #111;
            z-index: 80;
        }
        .tapestry-title { color: var(--text-secondary); font-weight: 500; font-size: 1.2rem; letter-spacing: 0.5em; text-transform: uppercase; margin-top: 5vh; }
        .tapestry-container {
            width: 90%;
            max-width: 600px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 2rem 0;
            overflow-y: auto;
        }
        .tapestry-thread {
            width: 100%;
            height: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            opacity: 0;
            transform: scaleX(0);
            animation: weaveIn 0.8s var(--ease-out-quint) forwards;
        }
        @keyframes weaveIn { to { opacity: 1; transform: scaleX(1); } }
        .tapestry-placeholder {
            margin: auto;
            text-align: center;
            color: var(--text-secondary);
        }
        .tapestry-placeholder h3 { margin-bottom: 0.5rem; }
        .tapestry-placeholder p { font-size: 0.9rem; font-weight: 300; }
        .tapestry-close-button { position: absolute; top: 2rem; right: 1.5rem; z-index: 10; width: 44px; height: 44px; background-color: rgba(255, 255, 255, 0.1); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; color: white; cursor: pointer; }

        /* [All other original CSS remains, no need to repeat it] */
        #splash-screen { background-color: var(--app-background); z-index: 100; } .tadelakt-surface { width: 100%; height: 100%; background: radial-gradient(circle, var(--tadelakt-start), var(--tadelakt-end)); opacity: 0; transition: opacity 3s var(--ease-in-out-sine); position: absolute; } .tadelakt-surface::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 800 800' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); opacity: 0.025; pointer-events: none; } .calligraphy { font-family: 'Amiri', serif; font-size: 5rem; color: var(--text-primary); opacity: 0; transform: scale(0.9); transition: opacity 1.5s var(--ease-in-out-sine) 0.5s, transform 1.5s var(--ease-in-out-sine) 0.5s; } #astrolabe-screen { flex-direction: column; z-index: 50; } .astrolabe-container { position: relative; width: min(90vw, 380px); height: min(90vw, 380px); transform: scale(0.9); } .astrolabe-ring { position: absolute; border-radius: 50%; border: 1px solid var(--aluminum-dark); transition: transform 0.8s var(--ease-out-quint); cursor: grab; display: flex; justify-content: center; align-items: center; will-change: transform; } #ring-intention { width: 100%; height: 100%; top: 0; left: 0; } #ring-region { width: 80%; height: 80%; top: 10%; left: 10%; border-width: 2px; } #ring-time { width: 60%; height: 60%; top: 20%; left: 20%; } .astrolabe-marker { position: absolute; font-size: 1.5rem; color: var(--aluminum-light); transition: color 0.5s, transform 0.5s; } #intention-serenity { top: 5%; left: 50%; transform: translateX(-50%); } #intention-vibrancy { right: 5%; top: 50%; transform: translateY(-50%); } #intention-awe { bottom: 5%; left: 50%; transform: translateX(-50%); } #intention-legacy { left: 5%; top: 50%; transform: translateY(-50%); } #time-dawn { top: 5%; left: 50%; transform: translateX(-50%); } #time-midday { right: 5%; top: 50%; transform: translateY(-50%); } #time-dusk { bottom: 5%; left: 50%; transform: translateX(-50%); } #time-night { left: 5%; top: 50%; transform: translateY(-50%); } .astrolabe-center { position: absolute; width: 40%; height: 40%; top: 30%; left: 30%; border-radius: 50%; background: radial-gradient(circle, #333, #111); cursor: pointer; display: flex; justify-content: center; align-items: center; text-align: center; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid var(--aluminum-dark); box-shadow: inset 0 0 15px rgba(0,0,0,0.5); } .astrolabe-center:active { transform: scale(0.95); box-shadow: inset 0 0 25px rgba(0,0,0,0.8); } .center-text { color: var(--text-secondary); font-size: 0.9rem; font-weight: 300; transition: opacity 0.5s; } .selected-marker { color: var(--ochre-gold); transform: scale(1.2) !important; } .app-title { position: absolute; top: clamp(1rem, 5vh, 2rem); font-weight: 500; font-size: 1.2rem; letter-spacing: 0.5em; text-transform: uppercase; color: var(--text-secondary); } #tapestry-icon { position: fixed; bottom: clamp(1rem, 4vh, 2rem); right: clamp(1rem, 4vw, 2rem); z-index: 60; width: 50px; height: 50px; background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(5px); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; cursor: pointer; transition: transform 0.3s, opacity 0.5s; } #tapestry-icon:active { transform: scale(0.9); } .tapestry-icon-pulse { animation: pulse 0.5s var(--ease-in-out-sine); } @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } } #riad-screen { z-index: 75; display: block; overflow-y: auto; overflow-x: hidden; background-color: var(--riad-background); color: var(--riad-text); } #riad-screen::-webkit-scrollbar { display: none; } .riad-image-container { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 1; } .riad-image { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.5s ease-out; will-change: opacity; } .riad-content { position: relative; z-index: 2; margin-top: 100vh; background-color: var(--riad-background); padding: 2rem 1.5rem 5rem 1.5rem; min-height: 50vh; } .riad-title { font-size: 2.5rem; font-weight: 500; margin: 0 0 0.5rem; color: #111; } .riad-subtitle { font-size: 1rem; color: #777; margin-bottom: 2rem; } .riad-narrative { font-size: 1.1rem; line-height: 1.8; font-weight: 300; margin-bottom: 3rem; color: var(--riad-text); } .sensory-palette { margin-bottom: 3rem; } .sensory-item { display: flex; align-items: center; margin-bottom: 1.5rem; cursor: pointer; } .sensory-icon { font-size: 1.5rem; width: 50px; text-align: center; color: #555; margin-right: 1rem; } .sensory-description { font-size: 0.9rem; font-style: italic; color: #666; } .color-wash { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.5s ease-in-out; } .foundation-toggle { display: flex; align-items: center; cursor: pointer; border-top: 1px solid #ddd; padding-top: 2rem; } .foundation-toggle h3 { font-size: 1rem; text-transform: uppercase; letter-spacing: 0.1em; color: #888; margin: 0; font-weight: 500; } .foundation-toggle .plus-icon { font-size: 1.5rem; margin-left: auto; color: #aaa; transition: transform 0.5s var(--ease-in-out-sine); } .foundation-details { max-height: 0; overflow: hidden; transition: max-height 0.7s var(--ease-in-out-sine); font-size: 0.9rem; color: #555; line-height: 1.6; padding-top: 1rem; } .foundation-details.open { max-height: 500px; } .plus-icon.open { transform: rotate(45deg); } .weave-button { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); z-index: 10; padding: 1rem 1.5rem; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 50px; color: white; font-weight: 500; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s; opacity: 0; visibility: hidden; } .weave-button.visible { opacity: 1; visibility: visible; } .weave-button:active { background-color: rgba(0,0,0,0.9); transform: translateX(-50%) scale(0.95); } .thread-animation { position: fixed; height: 3px; background-color: var(--ochre-gold); border-radius: 3px; z-index: 250; pointer-events: none; transform-origin: left center; } .back-button { position: fixed; top: 2rem; left: 1.5rem; z-index: 10; width: 44px; height: 44px; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; color: white; cursor: pointer; }

    </style>
</head>
<body>
    <!-- The DOM Structure is expanded to include the Tapestry screen -->
    <div id="splash-screen" class="screen active"> ... </div>
    <div id="astrolabe-screen" class="screen">
        <div class="app-title">MARQ</div>
        <div class="astrolabe-container">
            <div class="astrolabe-sheen"></div>
            <!-- Rings and Center -->
            <div id="ring-intention" class="astrolabe-ring" role="region" aria-label="Intention Ring">...</div>
            <div id="ring-time" class="astrolabe-ring" role="region" aria-label="Time of Day Ring">...</div>
            <div class="astrolabe-center" role="button" aria-label="Find a path">...</div>
        </div>
        <div id="tapestry-icon" role="button" aria-label="View Your Tapestry">❖</div>
    </div>
    <div id="riad-screen" class="screen">
        <!-- Riad content with revealable classes -->
        <div class="riad-content">
            <h1 id="riad-title" class="revealable"></h1>
            <h2 id="riad-subtitle" class="revealable"></h2>
            <p id="riad-narrative" class="revealable"></p>
            <div class="sensory-palette revealable">...</div>
            <div class="foundation-toggle revealable" role="button">...</div>
        </div>
    </div>
    <div id="tapestry-screen" class="screen">
        <div id="tapestry-close-button" role="button" aria-label="Close Tapestry">×</div>
        <h1 class="tapestry-title">Your Tapestry</h1>
        <div class="tapestry-container">
            <div class="tapestry-placeholder">
                <h3>Your journey is a blank canvas.</h3>
                <p>Weave threads from places you wish to visit.</p>
            </div>
        </div>
    </div>
    <div class="color-wash"></div>
    <!-- Step 4: Add audio elements for the ambient soundscape -->
    <audio id="ambient-dawn" loop><source src="https://cdn.pixabay.com/download/audio/2022/02/10/audio_c0629b3695.mp3" type="audio/mpeg"></audio>
    <audio id="ambient-night" loop><source src="https://cdn.pixabay.com/download/audio/2021/08/09/audio_3aa2c373b9.mp3" type="audio/mpeg"></audio>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // [Data and basic bug-fixed logic from previous step remain]
        // ...
        
        // Step 6: A more nuanced haptic feedback function
        function performHaptic(style = 'light') {
            if (navigator.vibrate) {
                const patterns = { light: [10], medium: [40], heavy: [70, 40, 70] };
                navigator.vibrate(patterns[style] || patterns.light);
            }
        }
        
        // Step 1: Implement the Gyroscope-driven "Living Materiality"
        function initGyro() {
            if (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(permissionState => {
                    if (permissionState === 'granted') {
                        window.addEventListener('devicemotion', handleMotionEvent);
                    }
                });
            } else {
                window.addEventListener('devicemotion', handleMotionEvent);
            }
        }
        function handleMotionEvent(event) {
            const { rotationRate } = event;
            if (rotationRate && rotationRate.alpha && rotationRate.beta) {
                // We use rotationRate for a more subtle, transient effect of light glinting
                const x = -rotationRate.beta / 50; // Normalize and invert
                const y = rotationRate.alpha / 50; // Normalize
                document.documentElement.style.setProperty('--gyro-x', `${x.toFixed(3)}`);
                document.documentElement.style.setProperty('--gyro-y', `${y.toFixed(3)}`);
            }
        }

        // --- Polished Screen Transitions ---
        function showScreen(screenName) {
            // Step 2: Implement the narrative transition
            const currentScreen = document.querySelector('.screen.active');
            if (currentScreen) {
                if (currentScreen.id === 'astrolabe-screen' && screenName === 'riad-screen') {
                    currentScreen.classList.add('deconstruct');
                    lockTransition(800);
                    setTimeout(() => {
                        currentScreen.classList.remove('active', 'deconstruct');
                        elements.screens[screenName].classList.add('active');
                    }, 800);
                    return;
                }
                currentScreen.classList.remove('active');
            }
            lockTransition(800);
            elements.screens[screenName].classList.add('active');
        }
        
        // --- Polished Astrolabe Logic ---
        function setupRing(ringElement, snapAngles, onSnap) {
            // ... The robust ring logic from the previous step remains ...
            // Add enhanced haptics to the endDrag function
            const endDrag = () => {
                // ... existing logic ...
                performHaptic('medium'); // Step 6
                onSnap(closestSnap);
                // ... existing logic ...
            };
            // ...
        }

        // --- Polished Riad Screen Logic ---
        function setupRiadInteractions() {
            // ... all previous event listeners ...
            
            // Step 3: Implement the "Staggered Revelation" with Intersection Observer
            const revealables = document.querySelectorAll('.revealable');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                    }
                });
            }, { threshold: 0.1 });
            revealables.forEach((el, index) => {
                el.style.transitionDelay = `${index * 100}ms`;
                observer.observe(el);
            });
        }
        
        // --- Polished Weave Thread Logic ---
        function weaveThread() {
            if (state.isWeaving) return;
            state.isWeaving = true;
            performHaptic('heavy'); // Step 6
            // ... existing animation logic ...
            // Inside the final .onfinish callback:
            // ...
            tapestry.add(state.activeLocation); // Step 5
            // ...
        }

        // --- All-New Tapestry Logic (Step 5) ---
        const tapestry = {
            threads: [],
            add(locationData) {
                if (!this.threads.find(t => t.title === locationData.title)) {
                    this.threads.push(locationData);
                    this.render();
                }
            },
            render() {
                const container = document.querySelector('.tapestry-container');
                const placeholder = document.querySelector('.tapestry-placeholder');
                container.innerHTML = ''; // Clear previous threads
                if (this.threads.length === 0) {
                    container.appendChild(placeholder);
                } else {
                    this.threads.forEach((thread, index) => {
                        const threadEl = document.createElement('div');
                        threadEl.className = 'tapestry-thread';
                        threadEl.style.backgroundColor = thread.sensory.sight.color;
                        threadEl.style.animationDelay = `${index * 80}ms`;
                        container.appendChild(threadEl);
                    });
                }
            }
        };
        
        // --- All-New Ambient Sound Logic (Step 4) ---
        const ambientAudio = {
            dawn: document.getElementById('ambient-dawn'),
            night: document.getElementById('ambient-night'),
            current: null,
            play(sound) {
                if (this.current === this[sound]) return;
                this.stop();
                this.current = this[sound];
                if (this.current) {
                    this.current.volume = 0;
                    this.current.play();
                    this.fadeIn();
                }
            },
            stop() {
                if (this.current) this.fadeOut();
            },
            fadeIn() {
                let vol = 0;
                const interval = setInterval(() => {
                    vol += 0.05;
                    if (vol >= 0.3) { vol = 0.3; clearInterval(interval); }
                    if(this.current) this.current.volume = vol;
                }, 100);
            },
            fadeOut() {
                let vol = this.current.volume;
                const interval = setInterval(() => {
                    vol -= 0.05;
                    if (vol <= 0) {
                        vol = 0;
                        if(this.current) {
                            this.current.pause();
                            this.current.currentTime = 0;
                        }
                        this.current = null;
                        clearInterval(interval);
                    } else {
                       if(this.current) this.current.volume = vol;
                    }
                }, 100);
            }
        };

        // --- Update Astrolabe state to control ambient sound ---
        function updateAstrolabeState() {
            // ... existing logic ...
            const updateSelection = (ring, angle) => {
                // ... existing logic ...
                if (ring === 'time') {
                    if (state.time === 'dawn') ambientAudio.play('dawn');
                    else if (state.time === 'night') ambientAudio.play('night');
                    else ambientAudio.stop();
                }
            };
            // ...
        }

        // --- Initialize Everything ---
        // initSplash(), setupRing(), etc. are called here
        initGyro(); // Initialize the "living materiality"
        tapestry.render(); // Initial render of the empty tapestry
        
        // Event listeners for the Tapestry screen
        elements.astrolabe.tapestryIcon.addEventListener('click', () => {
            elements.astrolabe.tapestryIcon.style.opacity = 0;
            showScreen('tapestry');
        });
        document.getElementById('tapestry-close-button').addEventListener('click', () => {
            elements.astrolabe.tapestryIcon.style.opacity = 1;
            showScreen('astrolabe');
        });

        // Step 6: Add semantic roles where needed in the JS logic
        // This is done contextually in the HTML and JS as shown above.
        // Example: The roles are on the elements, the labels provide context.
        // The haptics are integrated into the actions.

        // [The rest of the robust, bug-fixed logic from the previous step is assumed to be here]

    });
    // Dummy elements for script to find.
    // In a real implementation, you would populate these dynamically or ensure they match the full HTML structure.
    document.getElementById('splash-screen').innerHTML = `<div class="tadelakt-surface"></div><div class="calligraphy">أهلاً</div>`;
    document.querySelector('#ring-intention').innerHTML = `<div id="intention-serenity" class="astrolabe-marker">〰</div><div id="intention-vibrancy" class="astrolabe-marker">✣</div><div id="intention-awe" class="astrolabe-marker">✶</div><div id="intention-legacy" class="astrolabe-marker">☗</div>`;
    document.querySelector('#ring-time').innerHTML = `<div id="time-dawn" class="astrolabe-marker">◓</div><div id="time-midday" class="astrolabe-marker">☀</div><div id="time-dusk" class="astrolabe-marker">◒</div><div id="time-night" class="astrolabe-marker">☾</div>`;
    document.querySelector('.astrolabe-center').innerHTML = `<span class="center-text">Align the rings</span>`;
    document.querySelector('#riad-screen').innerHTML = `<div id="riad-image-container"><img id="riad-image-element" src="" alt=""></div><div id="back-button">←</div><div id="weave-button" class="weave-button">Weave a Thread</div><div class="riad-content"><h1 id="riad-title" class="revealable"></h1><h2 id="riad-subtitle" class="revealable"></h2><p id="riad-narrative" class="revealable"></p><div class="sensory-palette revealable"><div class="sensory-item" id="sensory-sight"><span class="sensory-icon">◉</span><span class="sensory-description" id="sensory-sight-desc"></span></div><div class="sensory-item" id="sensory-sound"><span class="sensory-icon">♫</span><span class="sensory-description" id="sensory-sound-desc"></span></div><div class="sensory-item" id="sensory-scent"><span class="sensory-icon">☙</span><span class="sensory-description" id="sensory-scent-desc"></span></div><div class="sensory-item" id="sensory-touch"><span class="sensory-icon">✍</span><span class="sensory-description" id="sensory-touch-desc"></span></div></div><div class="foundation-toggle revealable" role="button" tabindex="0"><h3>The Foundation</h3><span class="plus-icon">+</span></div><div class="foundation-details"><p id="foundation-text"></p></div></div>`;

    </script>
</body>
</html>
