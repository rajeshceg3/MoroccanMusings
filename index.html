<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Marq</title>
    <style>
        /* [No changes to CSS, it remains as designed] */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Amiri:ital@1&display=swap');

        :root {
            --ease-out-quint: cubic-bezier(0.22, 1, 0.36, 1);
            --ease-in-out-sine: cubic-bezier(0.37, 0, 0.63, 1);
            --app-background: #000;
            --tadelakt-start: #282828;
            --tadelakt-end: #1a1a1a;
            --aluminum-light: #888;
            --aluminum-dark: #444;
            --text-primary: #e0e0e0;
            --text-secondary: #999;
            --majorelle-blue: #003399;
            --ochre-gold: #c67605;
            --riad-background: #fdfcf9; /* A softer, warmer white */
            --riad-text: #2d2d2d;
        }

        * {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--app-background);
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            overflow: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            visibility: hidden;
            transition: opacity 1.2s var(--ease-in-out-sine), visibility 1.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            will-change: opacity;
        }

        .screen.active {
            opacity: 1;
            visibility: visible;
        }
        
        body.transition-locked {
            pointer-events: none;
        }
        
        /* ... All other CSS from the original implementation remains unchanged ... */
        
        #splash-screen { background-color: var(--app-background); z-index: 100; }
        .tadelakt-surface { width: 100%; height: 100%; background: radial-gradient(circle, var(--tadelakt-start), var(--tadelakt-end)); opacity: 0; transition: opacity 3s var(--ease-in-out-sine); position: absolute; }
        .tadelakt-surface::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 800 800' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); opacity: 0.025; pointer-events: none; }
        .calligraphy { font-family: 'Amiri', serif; font-size: 5rem; color: var(--text-primary); opacity: 0; transform: scale(0.9); transition: opacity 1.5s var(--ease-in-out-sine) 0.5s, transform 1.5s var(--ease-in-out-sine) 0.5s; }
        #astrolabe-screen { flex-direction: column; z-index: 50; }
        .astrolabe-container { position: relative; width: min(90vw, 380px); height: min(90vw, 380px); transform: scale(0.9); }
        .astrolabe-ring { position: absolute; border-radius: 50%; border: 1px solid var(--aluminum-dark); transition: transform 0.8s var(--ease-out-quint); cursor: grab; display: flex; justify-content: center; align-items: center; will-change: transform; }
        #ring-intention { width: 100%; height: 100%; top: 0; left: 0; }
        #ring-region { width: 80%; height: 80%; top: 10%; left: 10%; border-width: 2px; }
        #ring-time { width: 60%; height: 60%; top: 20%; left: 20%; }
        .astrolabe-marker { position: absolute; font-size: 1.5rem; color: var(--aluminum-light); transition: color 0.5s, transform 0.5s; }
        #intention-serenity { top: 5%; left: 50%; transform: translateX(-50%); }
        #intention-vibrancy { right: 5%; top: 50%; transform: translateY(-50%); }
        #intention-awe { bottom: 5%; left: 50%; transform: translateX(-50%); }
        #intention-legacy { left: 5%; top: 50%; transform: translateY(-50%); }
        #time-dawn { top: 5%; left: 50%; transform: translateX(-50%); }
        #time-midday { right: 5%; top: 50%; transform: translateY(-50%); }
        #time-dusk { bottom: 5%; left: 50%; transform: translateX(-50%); }
        #time-night { left: 5%; top: 50%; transform: translateY(-50%); }
        .astrolabe-center { position: absolute; width: 40%; height: 40%; top: 30%; left: 30%; border-radius: 50%; background: radial-gradient(circle, #333, #111); cursor: pointer; display: flex; justify-content: center; align-items: center; text-align: center; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid var(--aluminum-dark); box-shadow: inset 0 0 15px rgba(0,0,0,0.5); }
        .astrolabe-center:active { transform: scale(0.95); box-shadow: inset 0 0 25px rgba(0,0,0,0.8); }
        .center-text { color: var(--text-secondary); font-size: 0.9rem; font-weight: 300; transition: opacity 0.5s; }
        .selected-marker { color: var(--ochre-gold); transform: scale(1.2) !important; }
        .app-title { position: absolute; top: clamp(1rem, 5vh, 2rem); font-weight: 500; font-size: 1.2rem; letter-spacing: 0.5em; text-transform: uppercase; color: var(--text-secondary); }
        #tapestry-icon { position: fixed; bottom: clamp(1rem, 4vh, 2rem); right: clamp(1rem, 4vw, 2rem); z-index: 40; width: 50px; height: 50px; background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(5px); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; cursor: pointer; transition: transform 0.3s; }
        #tapestry-icon:active { transform: scale(0.9); }
        .tapestry-icon-pulse { animation: pulse 0.5s var(--ease-in-out-sine); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        #riad-screen { z-index: 75; display: block; overflow-y: auto; overflow-x: hidden; background-color: var(--riad-background); color: var(--riad-text); }
        #riad-screen::-webkit-scrollbar { display: none; }
        .riad-image-container { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 1; }
        .riad-image { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.5s ease-out; will-change: opacity; }
        .riad-content { position: relative; z-index: 2; margin-top: 100vh; background-color: var(--riad-background); padding: 2rem 1.5rem 5rem 1.5rem; min-height: 50vh; }
        .riad-title { font-size: 2.5rem; font-weight: 500; margin: 0 0 0.5rem; color: #111; }
        .riad-subtitle { font-size: 1rem; color: #777; margin-bottom: 2rem; }
        .riad-narrative { font-size: 1.1rem; line-height: 1.8; font-weight: 300; margin-bottom: 3rem; color: var(--riad-text); }
        .sensory-palette { margin-bottom: 3rem; }
        .sensory-item { display: flex; align-items: center; margin-bottom: 1.5rem; cursor: pointer; }
        .sensory-icon { font-size: 1.5rem; width: 50px; text-align: center; color: #555; margin-right: 1rem; }
        .sensory-description { font-size: 0.9rem; font-style: italic; color: #666; }
        .color-wash { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.5s ease-in-out; }
        .foundation-toggle { display: flex; align-items: center; cursor: pointer; border-top: 1px solid #ddd; padding-top: 2rem; }
        .foundation-toggle h3 { font-size: 1rem; text-transform: uppercase; letter-spacing: 0.1em; color: #888; margin: 0; font-weight: 500; }
        .foundation-toggle .plus-icon { font-size: 1.5rem; margin-left: auto; color: #aaa; transition: transform 0.5s var(--ease-in-out-sine); }
        .foundation-details { max-height: 0; overflow: hidden; transition: max-height 0.7s var(--ease-in-out-sine); font-size: 0.9rem; color: #555; line-height: 1.6; padding-top: 1rem; }
        .foundation-details.open { max-height: 500px; }
        .plus-icon.open { transform: rotate(45deg); }
        .weave-button { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); z-index: 10; padding: 1rem 1.5rem; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 50px; color: white; font-weight: 500; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s; opacity: 0; visibility: hidden; }
        .weave-button.visible { opacity: 1; visibility: visible; }
        .weave-button:active { background-color: rgba(0,0,0,0.9); transform: translateX(-50%) scale(0.95); }
        .thread-animation { position: fixed; height: 3px; background-color: var(--ochre-gold); border-radius: 3px; z-index: 250; pointer-events: none; transform-origin: left center; }
        .back-button { position: fixed; top: 2rem; left: 1.5rem; z-index: 10; width: 44px; height: 44px; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; color: white; cursor: pointer; }

    </style>
</head>
<body>

    <!-- DOM Structure remains identical -->
    <div id="splash-screen" class="screen active">
        <div class="tadelakt-surface"></div>
        <div class="calligraphy">أهلاً</div>
    </div>
    <div id="astrolabe-screen" class="screen">
        <div class="app-title">MARQ</div>
        <div class="astrolabe-container">
            <div id="ring-intention" class="astrolabe-ring"><div id="intention-serenity" class="astrolabe-marker">〰</div><div id="intention-vibrancy" class="astrolabe-marker">✣</div><div id="intention-awe" class="astrolabe-marker">✶</div><div id="intention-legacy" class="astrolabe-marker">☗</div></div>
            <div id="ring-region" class="astrolabe-ring"></div>
            <div id="ring-time" class="astrolabe-ring"><div id="time-dawn" class="astrolabe-marker">◓</div><div id="time-midday" class="astrolabe-marker">☀</div><div id="time-dusk" class="astrolabe-marker">◒</div><div id="time-night" class="astrolabe-marker">☾</div></div>
            <div class="astrolabe-center"><span class="center-text">Align the rings</span></div>
        </div>
        <div id="tapestry-icon">❖</div>
    </div>
    <div id="riad-screen" class="screen">
        <div id="riad-image-container"><img id="riad-image-element" src="" alt=""></div>
        <div id="back-button">←</div>
        <div id="weave-button" class="weave-button">Weave a Thread</div>
        <div class="riad-content">
            <h1 id="riad-title"></h1><h2 id="riad-subtitle"></h2><p id="riad-narrative"></p>
            <div class="sensory-palette">
                <div class="sensory-item" id="sensory-sight"><span class="sensory-icon">◉</span><span class="sensory-description" id="sensory-sight-desc"></span></div>
                <div class="sensory-item" id="sensory-sound"><span class="sensory-icon">♫</span><span class="sensory-description" id="sensory-sound-desc"></span></div>
                <div class="sensory-item" id="sensory-scent"><span class="sensory-icon">☙</span><span class="sensory-description" id="sensory-scent-desc"></span></div>
                <div class="sensory-item" id="sensory-touch"><span class="sensory-icon">✍</span><span class="sensory-description" id="sensory-touch-desc"></span></div>
            </div>
            <div class="foundation-toggle"><h3>The Foundation</h3><span class="plus-icon">+</span></div>
            <div class="foundation-details"><p id="foundation-text"></p></div>
        </div>
    </div>
    <div class="color-wash"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // [Data remains unchanged]
        const locations = {
            "serenity.coast.dawn": { title: "Essaouira Ramparts", subtitle: "The Wind City of Africa", image: "https://images.unsplash.com/photo-1600223114232-23948a6021d7?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=1200", narrative: "As the first light kisses the ancient stone, the Skala de la Ville awakens. Here, the salt of the Atlantic spray mingles with the centuries-old scent of thuya wood. The cry of gulls is the only music, a timeless score for the slow dance of fishing boats on the horizon.", sensory: { sight: { desc: "The cool, oceanic blue of the fishing boats against the warm, sandstone ramparts.", color: "#4a7c82" }, sound: { desc: "The piercing calls of seagulls and the rhythmic crash of waves against stone.", audio: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_2d8977129f.mp3" }, scent: { desc: "Salt in the air, the dry aroma of historic wood, a hint of diesel from the port." }, touch: { desc: "The rough, gritty texture of the fortress walls, cool under the morning sun." } }, foundation: "Open from sunrise. Access is free. The best light for photography is within the first two hours after dawn. Wear layers; the wind is a constant companion." },
            "vibrancy.medina.midday": { title: "Fes el-Bali Souk", subtitle: "The Labyrinth of Time", image: "https://images.unsplash.com/photo-1559922199-1d3cef793f53?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=1200", narrative: "To enter the Fes medina at noon is to step out of time. Light filters through reed-covered alleys, illuminating a million moments at once. The air is thick with the scent of spices, the clang of the coppersmith's hammer, and the murmur of a thousand conversations. It is not a place you see, but a place you feel in your bones.", sensory: { sight: { desc: "The deep, earthy ochre of piled spices and dyed leather.", color: "#c67605" }, sound: { desc: "The rhythmic tapping of metalworkers, the call of vendors, the hum of the crowd.", audio: "https://cdn.pixabay.com/download/audio/2022/04/18/audio_8213a48a90.mp3" }, scent: { desc: "Cumin and saffron, cedarwood, mint tea, the pungent smell of the tanneries." }, touch: { desc: "The smooth coolness of a brass tray, the soft pile of a carpet, the jostle of the crowd." } }, foundation: "The medina is always open, but most shops operate from 10 AM to 7 PM. It is wise to hire a guide for your first visit. Getting lost is part of the experience, but finding your way out is the goal." },
            "awe.sahara.dusk": { title: "Erg Chebbi Dunes", subtitle: "The Sea of Sand", image: "https://images.unsplash.com/photo-1554151249-8c267a3a6442?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=1200", narrative: "As the sun bleeds across the horizon, the Sahara performs its final, silent act of the day. The dunes, sculpted by wind and time, turn from gold to rose to deep violet. The world is reduced to two elements: the infinite sand beneath you and the infinite stars beginning to prick the sky above. Here, silence has a sound.", sensory: { sight: { desc: "The impossible gradient of the sunset, from fiery orange to the deepest indigo.", color: "#b85b47" }, sound: { desc: "The profound silence, broken only by the whisper of wind across sand.", audio: "https://cdn.pixabay.com/download/audio/2022/08/27/audio_32c864a329.mp3" }, scent: { desc: "The clean, dry scent of sand, the faint warmth of the cooling earth." }, touch: { desc: "The fine, soft grains of sand slipping through your fingers, still warm from the day's heat." } }, foundation: "Access is typically via 4x4 or camel trek from Merzouga. A guided overnight stay in a desert camp is the definitive experience. The temperature drops sharply after sunset." },
        };

        const state = {
            intention: null, region: null, time: null,
            activeScreen: 'splash', activeLocation: null,
            // FIX: Step 2 - Add state for tracking animation states
            isWeaving: false,
        };
        
        // FIX: Step 3 - Create a single, reusable audio player
        const audioPlayer = new Audio();

        // [DOM Element cache remains unchanged]
        const elements = { screens: { splash: document.getElementById('splash-screen'), astrolabe: document.getElementById('astrolabe-screen'), riad: document.getElementById('riad-screen') }, splash: { surface: document.querySelector('.tadelakt-surface'), calligraphy: document.querySelector('.calligraphy') }, astrolabe: { rings: { intention: document.getElementById('ring-intention'), region: document.getElementById('ring-region'), time: document.getElementById('ring-time') }, markers: { intention: document.querySelectorAll('#ring-intention .astrolabe-marker'), time: document.querySelectorAll('#ring-time .astrolabe-marker'), }, center: document.querySelector('.astrolabe-center'), centerText: document.querySelector('.center-text'), tapestryIcon: document.getElementById('tapestry-icon') }, riad: { imageContainer: document.getElementById('riad-image-container'), imageElement: document.getElementById('riad-image-element'), title: document.getElementById('riad-title'), subtitle: document.getElementById('riad-subtitle'), narrative: document.getElementById('riad-narrative'), sensory: { sight: document.getElementById('sensory-sight'), sightDesc: document.getElementById('sensory-sight-desc'), sound: document.getElementById('sensory-sound'), soundDesc: document.getElementById('sensory-sound-desc'), scent: document.getElementById('sensory-scent'), scentDesc: document.getElementById('sensory-scent-desc'), touch: document.getElementById('sensory-touch'), touchDesc: document.getElementById('sensory-touch-desc') }, foundation: { toggle: document.querySelector('.foundation-toggle'), plusIcon: document.querySelector('.plus-icon'), details: document.querySelector('.foundation-details'), text: document.getElementById('foundation-text') }, backButton: document.getElementById('back-button'), weaveButton: document.getElementById('weave-button') }, colorWash: document.querySelector('.color-wash') };
        
        // FIX: Step 2 - Implement the interaction lock
        function lockTransition(duration) {
            document.body.classList.add('transition-locked');
            setTimeout(() => {
                document.body.classList.remove('transition-locked');
            }, duration);
        }

        function showScreen(screenName) {
            state.activeScreen = screenName;
            lockTransition(1200); // Lock interaction during screen transitions
            for (const key in elements.screens) {
                elements.screens[key].classList.remove('active');
            }
            elements.screens[screenName].classList.add('active');
        }

        // --- Splash Screen Logic ---
        function initSplash() {
            setTimeout(() => { elements.splash.surface.style.opacity = '1'; }, 500);
            setTimeout(() => {
                elements.splash.calligraphy.style.opacity = '1';
                elements.splash.calligraphy.style.transform = 'scale(1)';
            }, 3000);
            setTimeout(() => {
                elements.screens.splash.addEventListener('click', () => {
                    elements.splash.calligraphy.style.opacity = '0';
                    showScreen('astrolabe');
                }, { once: true });
            }, 4500);
        }

        // --- Astrolabe Logic ---
        function setupRing(ringElement, snapAngles, onSnap) {
            let startAngle = 0;
            let currentRotation = 0;

            const getAngle = (e) => {
                const rect = ringElement.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return Math.atan2(clientY - centerY, clientX - centerX) * (180 / Math.PI);
            };

            // FIX: Step 1 - Define drag and endDrag functions to be added/removed
            const drag = (e) => {
                e.preventDefault();
                currentRotation = getAngle(e) - startAngle;
                ringElement.style.transform = `rotate(${currentRotation}deg)`;
            };

            const endDrag = () => {
                ringElement.style.transition = 'transform 0.8s var(--ease-out-quint)';
                document.body.style.cursor = 'default';

                const closestSnap = snapAngles.reduce((prev, curr) => (Math.abs(curr - currentRotation % 360) < Math.abs(prev - currentRotation % 360) ? curr : prev));
                const revolutions = Math.round(currentRotation / 360);
                let finalRotation = revolutions * 360 + closestSnap;
                if (Math.abs(currentRotation - (finalRotation - 360)) < Math.abs(currentRotation - finalRotation)) { finalRotation -= 360; }
                
                currentRotation = finalRotation;
                ringElement.style.transform = `rotate(${currentRotation}deg)`;
                if (navigator.vibrate) navigator.vibrate(10);
                onSnap(closestSnap);
                
                // FIX: Step 1 - Remove the listeners, ensuring the state is cleaned up
                window.removeEventListener('mousemove', drag);
                window.removeEventListener('mouseup', endDrag);
                window.removeEventListener('touchmove', drag);
                window.removeEventListener('touchend', endDrag);
            };
            
            const startDrag = (e) => {
                ringElement.style.transition = 'none';
                startAngle = getAngle(e) - currentRotation;
                document.body.style.cursor = 'grabbing';
                
                // FIX: Step 1 - Add listeners only when a drag starts
                window.addEventListener('mousemove', drag);
                window.addEventListener('mouseup', endDrag);
                window.addEventListener('touchmove', drag, { passive: false });
                window.addEventListener('touchend', endDrag);
            };
            
            ringElement.addEventListener('mousedown', startDrag);
            ringElement.addEventListener('touchstart', startDrag, { passive: false });
        }

        // [updateAstrolabeState and updateCenterText remain unchanged]
        function updateAstrolabeState() { const keys = { intention: ['serenity', 'vibrancy', 'awe', 'legacy'], time: ['dawn', 'midday', 'dusk', 'night'] }; const updateSelection = (ring, angle) => { const index = (Math.round(angle / 90) + 4) % 4; state[ring] = keys[ring][index]; const markers = elements.astrolabe.markers[ring]; markers.forEach((m, i) => m.classList.toggle('selected-marker', i === index)); updateCenterText(); }; setupRing(elements.astrolabe.rings.intention, [0, -90, -180, -270], (angle) => updateSelection('intention', angle)); setupRing(elements.astrolabe.rings.time, [0, -90, -180, -270], (angle) => updateSelection('time', angle)); }
        function updateCenterText() { if (state.intention && state.time) { const regionMap = { serenity: 'coast', vibrancy: 'medina', awe: 'sahara', legacy: 'kasbah' }; state.region = regionMap[state.intention]; elements.astrolabe.centerText.textContent = `Find a path for ${state.intention} at ${state.time}`; } else { elements.astrolabe.centerText.textContent = 'Align the rings'; } }

        // --- Riad Screen Logic ---
        function showRiad(locationData) {
            state.activeLocation = locationData;
            
            // FIX: Step 3 - Add an error handler for the image
            elements.riad.imageElement.onerror = () => {
                elements.riad.imageContainer.style.display = 'none'; // Hide the container on failure
            };
            elements.riad.imageContainer.style.display = 'block'; // Reset display property
            elements.riad.imageElement.src = locationData.image;

            elements.riad.title.textContent = locationData.title;
            elements.riad.subtitle.textContent = locationData.subtitle;
            elements.riad.narrative.textContent = locationData.narrative;
            elements.riad.sensory.sight.dataset.color = locationData.sensory.sight.color;
            elements.riad.sensory.sightDesc.textContent = locationData.sensory.sight.desc;
            elements.riad.sensory.sound.dataset.audio = locationData.sensory.sound.audio;
            elements.riad.sensory.soundDesc.textContent = locationData.sensory.sound.desc;
            elements.riad.sensory.scentDesc.textContent = locationData.sensory.scent.desc;
            elements.riad.sensory.touchDesc.textContent = locationData.sensory.touch.desc;
            elements.riad.foundation.text.textContent = locationData.foundation;
            elements.riad.weaveButton.dataset.color = locationData.sensory.sight.color;

            elements.screens.riad.scrollTop = 0;
            elements.riad.imageContainer.style.opacity = 1;
            elements.riad.weaveButton.classList.remove('visible');
            setTimeout(() => elements.riad.weaveButton.classList.add('visible'), 1500);

            showScreen('riad');
        }

        function setupRiadInteractions() {
            elements.riad.backButton.addEventListener('click', () => {
                showScreen('astrolabe');
                elements.riad.weaveButton.classList.remove('visible');
            });

            elements.screens.riad.addEventListener('scroll', () => {
                const scrollY = elements.screens.riad.scrollTop;
                const opacity = Math.max(0, 1 - (scrollY / (window.innerHeight * 0.7)));
                elements.riad.imageContainer.style.opacity = opacity;
            });

            elements.riad.sensory.sight.addEventListener('click', (e) => {
                const color = e.currentTarget.dataset.color;
                elements.colorWash.style.backgroundColor = color;
                elements.colorWash.style.opacity = 1;
                setTimeout(() => { elements.colorWash.style.opacity = 0; }, 600);
            });

            elements.riad.sensory.sound.addEventListener('click', (e) => {
                // FIX: Step 3 - Use the single, reusable audio player
                const audioSrc = e.currentTarget.dataset.audio;
                if (audioSrc) {
                    audioPlayer.src = audioSrc;
                    audioPlayer.play();
                }
            });

            elements.riad.foundation.toggle.addEventListener('click', () => {
                elements.riad.foundation.details.classList.toggle('open');
                elements.riad.foundation.plusIcon.classList.toggle('open');
            });

            // "Weave a Thread" gesture
            let pressTimer;
            const startWeave = (e) => { e.preventDefault(); pressTimer = setTimeout(weaveThread, 1000); };
            const cancelWeave = () => clearTimeout(pressTimer);
            elements.riad.weaveButton.addEventListener('mousedown', startWeave);
            elements.riad.weaveButton.addEventListener('touchstart', startWeave);
            elements.riad.weaveButton.addEventListener('mouseup', cancelWeave);
            elements.riad.weaveButton.addEventListener('mouseleave', cancelWeave);
            elements.riad.weaveButton.addEventListener('touchend', cancelWeave);
        }

        function weaveThread() {
            // FIX: Step 2 - Prevent multiple animations
            if (state.isWeaving) return;
            state.isWeaving = true;

            const thread = document.createElement('div');
            thread.className = 'thread-animation';
            const startRect = elements.riad.weaveButton.getBoundingClientRect();
            const endRect = elements.astrolabe.tapestryIcon.getBoundingClientRect();
            const startX = startRect.left + startRect.width / 2;
            const startY = startRect.top + startRect.height / 2;
            const endX = endRect.left + endRect.width / 2;
            const endY = endRect.top + endRect.height / 2;
            const deltaX = endX - startX;
            const deltaY = endY - startY;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            const angle = Math.atan2(deltaY, deltaX) * (180 / Math.PI);
            
            thread.style.cssText = `left: ${startX}px; top: ${startY}px; width: ${distance}px; transform: rotate(${angle}deg); background-color: ${elements.riad.weaveButton.dataset.color || 'var(--ochre-gold)'};`;
            document.body.appendChild(thread);
            
            thread.animate([{ transform: `rotate(${angle}deg) scaleX(0)` }, { transform: `rotate(${angle}deg) scaleX(1)` }], { duration: 600, easing: 'cubic-bezier(0.7, 0, 0.3, 1)' })
            .onfinish = () => {
                thread.animate([{ opacity: 1 }, { opacity: 0 }], { duration: 200 })
                .onfinish = () => {
                    thread.remove();
                    elements.astrolabe.tapestryIcon.classList.add('tapestry-icon-pulse');
                    setTimeout(() => {
                        elements.astrolabe.tapestryIcon.classList.remove('tapestry-icon-pulse');
                        state.isWeaving = false; // Reset the lock
                    }, 500);
                }
            };
        }

        // --- Initialization ---
        initSplash();
        updateAstrolabeState();
        setupRiadInteractions();

        elements.astrolabe.center.addEventListener('click', () => {
            const path = `${state.intention}.${state.region}.${state.time}`;
            const targetLocation = locations[path];
            if (targetLocation) {
                showRiad(targetLocation);
            } else {
                elements.astrolabe.center.animate([{ transform: 'translateX(0px)' }, { transform: 'translateX(-5px)' }, { transform: 'translateX(5px)' }, { transform: 'translateX(0px)' }], { duration: 300, iterations: 1 });
                elements.astrolabe.centerText.textContent = 'No path found';
                setTimeout(updateCenterText, 2000);
            }
        });
    });
    </script>
</body>
</html>
